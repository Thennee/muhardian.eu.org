<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scan QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#0d47ff,#00c6ff);
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
  font-family:Segoe UI,Arial;
}

.box{
  width:100%;
  max-width:420px;
  padding:15px;
  text-align:center;
}

#reader{
  width:100%;
  border-radius:16px;
  overflow:hidden;
}

h2{margin-bottom:12px;}
</style>
</head>
<body>

<div class="box">
  <h2>Scan QR Code</h2>
  <div id="reader"></div>
  <p id="info"></p>
</div>

<script>
const API_URL = "PASTE_URL_WEB_APP_DISINI";

const urlToken = new URLSearchParams(location.search).get("token");
const sessionToken = sessionStorage.getItem("scan_token");

if(!urlToken || urlToken !== sessionToken){
  alert("Akses tidak valid.");
  location.href="index.html";
}

const info = document.getElementById("info");

function onScanSuccess(decodedText) {

  info.textContent = "Mengirim hasil scan...";

  html5QrCode.stop();

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      type:"scan",
      hasil_scan: decodedText
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="success"){
      sessionStorage.removeItem("scan_token");
      location.href="index.html";
    }else{
      info.textContent="Gagal menyimpan.";
    }
  })
  .catch(()=>{
    info.textContent="Koneksi gagal.";
  });
}

const html5QrCode = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras=>{
  let backCam = cameras[0];

  cameras.forEach(cam=>{
    if(cam.label.toLowerCase().includes("back")){
      backCam = cam;
    }
  });

  html5QrCode.start(
    backCam.id,
    { fps:10, qrbox:{width:250,height:250} },
    onScanSuccess
  );

});
</script>

</body>
</html>
